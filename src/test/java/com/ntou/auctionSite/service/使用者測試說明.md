# 使用者服務測試說明

## 📋 測試概述

本測試檔案 `UserServiceTest.java` 為 `UserService` 提供完整的單元測試與整合測試，涵蓋所有核心功能與邊界情況。

## 🎯 測試範圍

### 1. 取得使用者資訊 (getUserInfo)
- ✅ 成功取得完整使用者資訊
- ✅ 使用者不存在時的異常處理
- ✅ 沒有販售商品時的處理

### 2. 更新使用者資訊 (updateUserInfo)
- ✅ 更新所有欄位
- ✅ 部分欄位更新
- ✅ 使用者名稱重複檢查
- ✅ 電子郵件重複檢查
- ✅ 允許更新為相同的使用者名稱
- ✅ 使用者不存在時的異常處理
- ✅ 空白字串不更新欄位

### 3. 更新密碼 (updatePassword)
- ✅ 成功更新密碼
- ✅ 目前密碼錯誤的異常處理
- ✅ 新密碼與舊密碼相同的異常處理
- ✅ 使用者不存在時的異常處理

### 4. 取得公開使用者資訊 (getPublicUserInfo)
- ✅ 成功取得公開資訊
- ✅ 使用者不存在時的異常處理
- ✅ 包含多個販售商品的情況

### 5. 更新剩餘抽獎次數 (updateRemainingDrawTimes)
- ✅ 成功更新抽獎次數
- ✅ 減少到 0 的情況
- ✅ 使用者不存在時的異常處理

### 6. 邊界情況測試
- ✅ 處理 null 值並提供預設值
- ✅ 空白字串的處理

### 7. 完整生命週期整合測試
- ✅ 完整使用者操作流程測試

## 🚀 執行測試

### 方法 1：使用 Maven 執行所有測試
```bash
mvn test
```

### 方法 2：只執行使用者服務測試
```bash
mvn test -Dtest=UserServiceTest
```

### 方法 3：在 IDE 中執行
1. 在 IntelliJ IDEA 中開啟 `UserServiceTest.java`
2. 點擊類別旁的綠色執行按鈕
3. 或右鍵點擊檔案，選擇「Run 'UserServiceTest'」

### 方法 4：執行特定測試方法
```bash
mvn test -Dtest=UserServiceTest#testGetUserInfo_Success
```

## 📊 測試結果範例

執行測試後，您會看到類似以下的輸出：

```
✓ 測試成功：取得使用者資訊
  使用者名稱: testuser
  販售商品數量: 1

✓ 測試成功：使用者不存在時拋出異常

✓ 測試成功：更新所有使用者資訊
  新使用者名稱: newusername
  新電子郵件: newemail@example.com

✓ 測試成功：更新密碼

開始完整使用者生命週期測試
  ✓ 步驟 1: 取得初始使用者資訊
  ✓ 步驟 2: 更新使用者資訊
  ✓ 步驟 3: 更新密碼
  ✓ 步驟 4: 取得公開使用者資訊
  ✓ 步驟 5: 更新抽獎次數
✓ 完整使用者生命週期測試成功
```

## 📝 測試資料說明

### 測試使用者資料
```java
使用者名稱: testuser
電子郵件: testuser@example.com
密碼: password123
暱稱: 測試使用者
地址: 台北市中正區
電話: 0912345678
平均評分: 4.5
評分人數: 10
封鎖狀態: false
剩餘抽獎次數: 5
```

### 測試商品資料
```java
商品 ID: TEST_PRODUCT_001
商品名稱: 測試商品
商品描述: 這是一個測試商品
價格: 1000
庫存: 5
類別: 測試類別
狀態: ACTIVE
```

## 🔍 測試方法詳解

### 1. setUp() - 測試前置作業
- 清理所有測試資料
- 建立測試使用者
- 建立測試商品
- 每個測試方法執行前都會執行

### 2. tearDown() - 測試後清理
- 清理所有測試資料
- 確保測試之間不互相影響
- 每個測試方法執行後都會執行

### 3. 測試命名規範
- 格式：`test方法名稱_測試情境`
- 例如：`testGetUserInfo_Success` 表示測試「取得使用者資訊」的「成功情境」

## ⚠️ 注意事項

### 1. 資料庫依賴
- 測試使用實際的 MongoDB 連線（透過 `@SpringBootTest`）
- 確保測試資料庫已啟動並可連線
- 測試會在執行前後清理資料

### 2. 密碼加密
- 測試使用實際的 `PasswordEncoder`
- 確保密碼加密邏輯正確

### 3. 測試隔離
- 每個測試方法獨立執行
- 使用 `@BeforeEach` 和 `@AfterEach` 確保測試隔離
- 測試之間不共享資料

### 4. 異常測試
- 使用 `assertThrows` 驗證異常拋出
- 檢查異常訊息是否正確

## 🧪 測試覆蓋率

本測試檔案涵蓋了 `UserService` 的所有公開方法：

| 方法名稱 | 測試數量 | 覆蓋率 |
|---------|---------|--------|
| getUserInfo | 3 | 100% |
| updateUserInfo | 6 | 100% |
| updatePassword | 4 | 100% |
| getPublicUserInfo | 3 | 100% |
| updateRemainingDrawTimes | 3 | 100% |

**總測試數量：24 個測試方法**

## 🐛 除錯建議

### 測試失敗時的檢查清單
1. ✓ 檢查 MongoDB 是否正常運行
2. ✓ 檢查資料庫連線設定
3. ✓ 檢查測試資料是否正確清理
4. ✓ 查看控制台輸出的錯誤訊息
5. ✓ 確認 `UserService` 的實作是否有變更

### 常見問題

**Q: 測試一直失敗，顯示連線錯誤**
A: 請確認 `application.yml` 中的 MongoDB 連線設定正確，且資料庫已啟動。

**Q: 測試通過但有警告訊息**
A: 警告訊息通常不影響測試結果，可能是 Spring Boot 或 MongoDB 的日誌訊息。

**Q: 如何只執行特定的測試**
A: 使用 `mvn test -Dtest=UserServiceTest#測試方法名稱`

## 📚 延伸閱讀

- [JUnit 5 官方文件](https://junit.org/junit5/docs/current/user-guide/)
- [Spring Boot Testing 官方文件](https://spring.io/guides/gs/testing-web/)
- [Mockito 文件](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)

## 🎉 測試完成後

所有測試通過後，您可以：
1. 查看測試覆蓋率報告
2. 提交程式碼到版本控制系統
3. 繼續開發其他功能
4. 撰寫更多的整合測試

---

**最後更新時間：** 2025-12-20  
**測試版本：** v1.0  
**維護人員：** GitHub Copilot

